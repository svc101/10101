HTTP/1.1 200 OK

<html>
<head>
    <title>PICK IMAGE</title>
</head>
<input type="file" accept="image/*" id="fileInput" style="display: none;" onchange="handleFile()">
<body style="display: table; width: 100%; height: 100%; text-align: center;">

<div style="display: table; width: 100%; height: 100%;">
    <div style="display: table-cell; vertical-align: middle;">
        <div style="text-align: center;">
            <button id="pickImageButton" onclick="pick()"><h1 style="font-size: 70px;">PICK IMAGE</h1></button>
            <button id="confirmButton" onclick="confirmSelection()" style="display: none;"><h1 style="font-size: 70px;">CONFIRM</h1></button>
        </div>
        <div id="imagePreview" style="text-align: center; margin-top: 20px; display: none;">
            <img id="previewImg" src="#" alt="Preview" style="max-width: 90%; max-height: 90%;">
        </div>
    </div>
</div>

<script>


document.addEventListener('DOMContentLoaded', function() {
	eventName = "visibilitychange";
});

document.addEventListener('visibilitychange', function() {
	if (document.hidden) {
		if (event.type === eventName) {
			var url = "http://localhost:%client/" + "close";
			var xhr = new XMLHttpRequest();
			xhr.open("POST", url, true);
			document.close()
			xhr.send();
		}
	}
});

function pick() {
	fileInput.click();
	confirmButton.style.display = "none"; // Hide the confirm button
    eventName = event.type;
    setTimeout(function() {
    	if (!fileInput.value) {
			eventName = "visibilitychange";
		}
    }, 10000);
}

function handleFile() {
	eventName = "visibilitychange";
    var reader = new FileReader();

    if (!fileInput.files[0].type.match('image.*')) {
        // Tampilkan peringatan jika bukan tipe gambar
        alert("Please select an image file !");
		imagePreview.style.display = "none"; // Sembunyikan preview jika bukan gambar
		confirmButton.style.display = "none"; // Sembunyikan tombol konfirmasi
		pickImageButton.style.display = "inline-block";
        return;
    }

    if (fileInput.files[0].size > 1000000) { // Check if file size is larger than 1MB (in bytes)
        var img = new Image();
        reader.onload = function(e) {
            img.src = e.target.result;
            img.onload = function() {
                var canvas = document.createElement("canvas");
                var ctx = canvas.getContext("2d");
                var MAX_WIDTH = 2000; // Set maximum width for compressed image
                var MAX_HEIGHT = 2000; // Set maximum height for compressed image
                var width = img.width;
                var height = img.height;
                while (fileInput.files[0].size > 1000000 && (width > MAX_WIDTH || height > MAX_HEIGHT)) {
                    width *= 0.9;
                    height *= 0.9;
                }
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                previewImg.src = canvas.toDataURL(fileInput.files[0].type);
                fileInput.files[0] = dataURItoBlob(canvas.toDataURL(fileInput.files[0].type));
            }
        };
        reader.readAsDataURL(fileInput.files[0]);
    } else {
        reader.onload = function(e) {
            previewImg.src = e.target.result;
        };
        reader.readAsDataURL(fileInput.files[0]);
    }
	imagePreview.style.display = "inline-block"; // Show the image preview
	confirmButton.style.display = "inline-block"; // Show the confirm button
}

function dataURItoBlob(dataURI) {
    var byteString = atob(dataURI.split(",")[1]);
    var mimeString = dataURI.split(",")[0].split(":")[1].split(";")[0];
    var ab = new ArrayBuffer(byteString.length);
    var ia = new Uint8Array(ab);

    for (var i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }
    var blob = new Blob([ab], { type: mimeString });
    return blob;
}

function confirmSelection() {
	confirmButton.style.display = "none"; // Hide the confirm button
    var url = "http://localhost:%client/" + fileInput.files[0].type + "$" + previewImg.src.split(",").pop();
    var xhr = new XMLHttpRequest();
    xhr.open("POST", url, true);
    xhr.send();
}
</script>
</body>
</html>